<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enviar Número</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }
    input, button {
      font-size: 16px;
      padding: 10px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h2>Enviar número para llamada</h2>
  <input type="tel" id="phoneNumber" placeholder="Ingresar el número" required>
  <!-- El botón es opcional si queremos llamada automática. Se deja para pruebas. -->
  <button onclick="sendPhoneNumber()">Enviar</button>

  <p id="responseMessage"></p>

  <script>
    let refParam = null;

    window.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      refParam = params.get("ref"); // Ej: ?ref=08333173-f98b-43f4-80db-38cff244b0a6

      if (!refParam) {
        console.log("No se encontró 'ref' en la URL. El usuario puede ingresar el número manualmente.");
        return;
      }

      console.log("refParam =", refParam);

      try {
        // 1) Llamamos a la API de BSL (o la que tengas) para obtener el número del paciente
        const bslUrl = `https://www.bsl.com.co/_functions/chatbot?_id=${refParam}`;
        console.log("Consultando datos del paciente en:", bslUrl);

        const resp = await fetch(bslUrl);
        if (!resp.ok) {
          throw new Error("Error al obtener datos del paciente. Código: " + resp.status);
        }
        const patientData = await resp.json();
        console.log("Datos del paciente:", patientData);

        // 2) Si la respuesta trae un campo "phone", lo ponemos en el input
        if (patientData.celular) {
          document.getElementById("phoneNumber").value = patientData.phone;
          // 3) Llamada automática
          sendPhoneNumber();
        } else {
          console.warn("No se encontró 'phone' en los datos. El usuario debe ingresarlo manualmente.");
        }
      } catch (error) {
        console.error("Error al obtener datos del paciente:", error);
      }
    });

    // Función para hacer la llamada a tu backend /make-call
    async function sendPhoneNumber() {
      const phoneNumber = document.getElementById("phoneNumber").value.trim();
      if (!phoneNumber) {
        alert("Por favor ingresa un número.");
        return;
      }

      try {
        // Cambia la URL a la de tu backend en DigitalOcean o donde tengas tu API
        const makeCallUrl = "https://jellyfish-app-tcjx4.ondigitalocean.app/make-call";
        console.log("Iniciando llamada a:", makeCallUrl, "con phone:", phoneNumber, "y ref:", refParam);

        const response = await fetch(makeCallUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            phone: phoneNumber,
            ref: refParam || "" 
          })
        });

        const result = await response.json();
        console.log("Respuesta de /make-call:", result);
        document.getElementById("responseMessage").innerText =
          result.message || "Llamada en curso...";
      } catch (error) {
        document.getElementById("responseMessage").innerText =
          "Error al realizar la llamada.";
        console.error("Error:", error);
      }
    }
  </script>
</body>
</html>
